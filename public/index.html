<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./styles/styles.css" rel="stylesheet">
    <title>Olympics Teams and Athletes</title>
    <style>
        html, body {
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex;
            margin: 0;
        }
        .sidebar {
            width: 300px;
            padding: 20px;
            border-right: 1px solid #ddd;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }
        .team-header, .player-header {
            width: 100%;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
        }
        .team-header img, .player-header img {
            max-width: 100px;
            margin-right: 20px;
        }
        .team-content, .player-content {
            overflow-y: auto;
        }
        .team-item, .player-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            cursor: pointer;
        }
        .team-item img, .player-item img {
            max-width: 50px;
            margin-right: 10px;
        }
        .player-details {
            display: none;
            flex-direction: column;
            padding: 20px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
            transition: width 0.3s;
        }
        .main-content {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        .home-item {
            height: 100px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f2f2f2;
        }
        .welcome-message {
            padding: 20px;
            text-align: center;
        }
        .loading-message {
            text-align: center;
            font-size: 1.5em;
            padding: 20px;
        }
        .event-header {
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }
    </style>
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyC6WBb87ng8iqq4tiqRujhSmK1tpozfrCc",
            authDomain: "olympics-c5b48.firebaseapp.com",
            projectId: "olympics-c5b48",
            storageBucket: "olympics-c5b48.appspot.com",
            messagingSenderId: "202029431723",
            appId: "1:202029431723:web:e68aaf9b7b8458015cf0ee",
            measurementId: "G-Y0FYXEC525"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        document.addEventListener("DOMContentLoaded", function() {
            const teamsContainer = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const mainContent = document.querySelector('.main-content');
            const playerDetails = document.createElement('div');
            playerDetails.className = 'player-details';

            mainContent.appendChild(playerDetails);

            async function fetchTeams() {
                try {
                    const response = await fetch('https://us-central1-olympics-c5b48.cloudfunctions.net/api/getTeams');
                    const teams = await response.json();
                    displayTeams(teams);
                } catch (error) {
                    console.error('Error fetching teams:', error);
                }
            }

            async function displayTeams(teams) {
                teamsContainer.innerHTML = '<div class="home-item" onclick="showHome()">Home</div>';
                for (const team of teams) {
                    const div = document.createElement('div');
                    div.className = 'team-item';
                    div.innerHTML = `
                        <img src="${await getCachedImageUrl(team.data.sport_image)}" alt="Sport Image">
                        <span>${team.data.display_name}</span>
                    `;
                    div.addEventListener('click', () => displayTeamDetails(team));
                    teamsContainer.appendChild(div);
                }
                showHome(); // Show home content by default
            }

            async function displayTeamDetails(team) {
                playerDetails.style.display = 'none';
                content.style.flexDirection = 'column';
                content.style.width = '100%';
                playerDetails.style.width = '0';
                content.innerHTML = `
                    <div class="team-header">
                        <img src="${await getCachedImageUrl(team.data.sport_image)}" alt="Sport Image">
                        <div>
                            <h2>${team.data.display_name}</h2>
                            <p class="team-description">${team.data.description}</p>
                        </div>
                    </div>
                    <div class="loading-message">Loading athletes...</div>
                `;
                history.pushState(null, '', `#${team.data.display_name.replace(/\s+/g, '-')}`);
                const response = await fetch(`https://us-central1-olympics-c5b48.cloudfunctions.net/api/getAthletes?sport=${team.id}`);
                const athletes = await response.json();
                displayAthletes(athletes, team.data.display_name);
            }

            async function displayAthletes(athletes, teamName) {
                const athletesByEvent = {};
                athletes.forEach(athlete => {
                    athlete.data.event.forEach(event => {
                        if (!athletesByEvent[event]) {
                            athletesByEvent[event] = [];
                        }
                        athletesByEvent[event].push(athlete);
                    });
                });

                content.innerHTML = `
                    <div class="team-header">
                        ${document.querySelector('.team-header').innerHTML}
                    </div>
                `;

                for (const event in athletesByEvent) {
                    const eventHeader = document.createElement('div');
                    eventHeader.className = 'event-header';
                    eventHeader.textContent = event;
                    content.appendChild(eventHeader);

                    // Sort athletes by name
                    athletesByEvent[event].sort((a, b) => a.data.name.localeCompare(b.data.name));

                    const eventList = document.createElement('div');
                    eventList.className = 'event-list';
                    athletesByEvent[event].forEach(async athlete => {
                        const div = document.createElement('div');
                        div.className = 'player-item';
                        div.innerHTML = `
                            <img src="${await getCachedImageUrl(athlete.data.profile_image)}" alt="Profile Image">
                            <span>${athlete.data.name}</span>
                        `;
                        div.addEventListener('click', () => displayPlayerDetails(athlete, teamName));
                        eventList.appendChild(div);
                    });
                    content.appendChild(eventList);
                }
            }

            async function displayPlayerDetails(athlete, teamName) {
                playerDetails.style.display = 'flex';
                playerDetails.style.flexDirection = 'column';
                playerDetails.style.overflowY = 'auto';
                content.style.width = '300px';
                playerDetails.style.width = 'calc(100% - 400px)';
                playerDetails.innerHTML = '<div class="loading-message">Loading athlete...</div>';
                let profileImageUrl = '';
                let headerImageUrl = '';

                                // Remove the team description when an athlete is clicked
                const teamDescription = document.querySelector('.team-description');
                if (teamDescription) {
                    teamDescription.style.display = 'none';
                }

                try {
                    profileImageUrl = await getCachedImageUrl(athlete.data.profile_image);
                } catch (error) {
                    console.log('No profile photo found');
                }

                try {
                    headerImageUrl = await getCachedImageUrl(athlete.data.header_image);
                } catch (error) {
                    console.log('No header photo found');
                }

                playerDetails.innerHTML = `
                    <div class="player-header">
                        ${headerImageUrl ? `<img src="${headerImageUrl}" alt="Header Image">` : ''}
                        <div>
                            <h2>${athlete.data.name}</h2>
                            <p>${athlete.data.hometown}</p>
                        </div>
                    </div>
                    <div class="player-content">
                        ${profileImageUrl ? `<img src="${profileImageUrl}" alt="Profile Image" style="max-width: 150px; border-radius: 50%; margin: 20px 0;">` : ''}
                        <p><strong>Previous Olympics:</strong> ${athlete.data.previous_olympics ?? 0}</p>
                        <p><strong>Description:</strong> ${athlete.data.description}</p>
                        <a href="${athlete.data.instagram}" target="_blank">Instagram</a>
                    </div>
                `;

                history.pushState(null, '', `#${teamName.replace(/\s+/g, '-')}/${athlete.data.name.replace(/\s+/g, '-')}`);
                console.log("Player details loaded:", athlete.data.name);
            }

            async function getCachedImageUrl(gsUrl) {
                if (!gsUrl) return '';
                const cachedUrl = localStorage.getItem(gsUrl);
                if (cachedUrl) {
                    console.log(`Using cached URL for ${gsUrl}`);
                    return cachedUrl;
                }
                try {
                    const url = await firebase.storage().refFromURL(gsUrl).getDownloadURL();
                    localStorage.setItem(gsUrl, url);
                    console.log(`Fetched and cached URL for ${gsUrl}`);
                    return url;
                } catch (error) {
                    console.error('Error fetching image URL:', error);
                    return '';
                }
            }

            window.showHome = function() {
                content.style.display = 'block';
                content.style.flexDirection = 'column';
                content.style.width = '100%';
                playerDetails.style.width = '0';
                playerDetails.style.display = 'none';
                content.innerHTML = `
                    <div class="welcome-message">
                        <h2>Welcome to the Olympics Teams and Athletes</h2>
                        <p>This is a brief description of the Olympics. Here you can explore various teams and athletes participating in the Olympics.</p>
                    </div>
                `;
                history.pushState(null, '', '#home');
            };

            // Fetch teams on page load
            fetchTeams();
        });
    </script>
</head>
<body>
    <div class="sidebar">
        <!-- Teams will be dynamically populated here -->
    </div>
    <div class="main-content">
        <div class="content"></div>
    </div>
</body>
</html>
